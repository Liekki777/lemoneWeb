---
// src/pages/blog/[...page].astro
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import type { Page } from 'astro';  // ← Para tipado perfecto de 'page'

// Tipado oficial para Props
interface Props {
  page: Page<CollectionEntry<'blog'>>;
}

export async function getStaticPaths({ paginate }: { paginate: (items: CollectionEntry<'blog'>[], options?: { pageSize?: number }) => unknown }) {  // ← ¡AQUÍ ESTÁ LA MAGIA! paginate viene del argumento
  const posts = await getCollection('blog');
  const sortedPosts = posts.sort(
    (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
  );

  return paginate(sortedPosts, { pageSize: 3 });  // ← Sin @ts-ignore, porque ahora está tipado
}

const { page } = Astro.props as Props;
---

<Layout title={`Blog${page.currentPage > 1 ? ` - Página ${page.currentPage}` : ''}`}>
  <Navbar />

  <div class="container py-5">
    <h1 class="display-5 fw-bold text-center mb-5">Blog</h1>

    <!-- Debug temporal (borra cuando quieras) -->
    <div class="alert alert-success text-center mb-4">
      ¡FUNCIONA! Página {page.currentPage} – {page.data.length} de {page.total} posts
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
      {page.data.map((post: CollectionEntry<'blog'>) => (
        <div class="col">
          <article class="card h-100 shadow-sm hover-shadow">
            <div class="card-body d-flex flex-column">
              <h3 class="card-title h5">
                <a href={`/blog/${post.slug}`} class="text-decoration-none text-dark stretched-link">
                  {post.data.title}
                </a>
              </h3>
              <p class="text-muted small mb-2">
                <i class="bi bi-calendar3"></i> {post.data.pubDate.toLocaleDateString('es-ES')} • {post.data.author}
              </p>
              <p class="card-text flex-grow-1">{post.data.description}</p>
              <div class="mt-auto d-flex gap-2 flex-wrap align-items-center">
                {post.data.tags.map((tag: string) => (
                  <span class="badge bg-primary">{tag}</span>
                ))}
                <a href={`/blog/${post.slug}`} class="btn btn-outline-primary btn-sm ms-auto">
                  Leer más →
                </a>
              </div>
            </div>
          </article>
        </div>
      ))}
    </div>

    <!-- Paginación Bootstrap oficial -->
    {page.lastPage > 1 && (
      <nav aria-label="Paginación del blog" class="mt-5">
        <ul class="pagination justify-content-center pagination-lg">
          {page.url.prev && (
            <li class="page-item">
              <a class="page-link" href={page.url.prev} aria-label="Página anterior">
                ← Anterior
              </a>
            </li>
          )}
          {Array.from({ length: page.lastPage }, (_, i) => i + 1).map(n => (
            <li class={`page-item ${n === page.currentPage ? 'active' : ''}`}>
              <a class="page-link" href={n === 1 ? '/blog' : `/blog/${n}`} aria-label={`Ir a página ${n}`}>
                {n}
              </a>
            </li>
          ))}
          {page.url.next && (
            <li class="page-item">
              <a class="page-link" href={page.url.next} aria-label="Página siguiente">
                Siguiente →
              </a>
            </li>
          )}
        </ul>
      </nav>
    )}
  </div>
</Layout>

<style>
  .hover-shadow { transition: all 0.3s ease; }
  .hover-shadow:hover { 
    transform: translateY(-8px); 
    box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important; 
  }
</style>