---
// src/components/Search.astro
---
<!-- Modal con búsqueda personalizada -->
<div id="searchModalContainer" class="fixed inset-0 z-[100] flex items-start justify-center bg-black/50 p-4 pt-[10vh] hidden" aria-labelledby="searchModalTitle" role="dialog" aria-modal="true">
  <div id="searchModalContent" class="bg-white rounded-xl shadow-2xl w-full max-w-3xl flex flex-col max-h-[80vh] overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-center p-5 border-b border-gray-200">
      <h5 id="searchModalTitle" class="text-xl font-bold text-gray-900">Buscar en el blog</h5>
      <button type="button" id="closeSearchModalBtn" class="text-3xl text-gray-500 hover:text-gray-800 leading-none" aria-label="Cerrar">
        &times;
      </button>
    </div>
    <!-- Body -->
    <div class="p-5 flex-grow overflow-y-auto">
      <div class="search-container">
        <input 
          type="text" 
          id="searchInput" 
          class="w-full p-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
          placeholder="Escribe para buscar..."
        />
        <div id="searchResults" class="mt-4 max-h-[55vh] overflow-y-auto grid md:grid-cols-2 gap-3 p-1"></div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  /* Estilo para el resaltado de Pagefind que no se puede hacer con Tailwind */
  mark {
    background-color: #ffea7a;
    color: #1a1a1a;
    padding: 0 3px;
    border-radius: 3px;
  }

  /* Scrollbar sutil */
  #searchResults::-webkit-scrollbar { height: 8px; width: 8px; }
  #searchResults::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 8px; }
  #searchResults::-webkit-scrollbar-track { background: transparent; }
</style>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    // --- Modal Control ---
    const searchModalContainer = document.getElementById('searchModalContainer');
    const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
    const searchBtnDesktop = document.getElementById('searchBtnDesktop');
    const searchBtnMobile = document.getElementById('searchBtnMobile');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    if (!searchModalContainer || !searchInput || !searchResults) return;

    const openModal = () => {
      searchModalContainer.classList.remove('hidden');
      setTimeout(() => (searchInput as HTMLInputElement).focus(), 50);
    };

    const closeModal = () => {
      searchModalContainer.classList.add('hidden');
    };

    searchBtnDesktop?.addEventListener('click', openModal);
    searchBtnMobile?.addEventListener('click', openModal);
    closeSearchModalBtn?.addEventListener('click', closeModal);
    searchModalContainer.addEventListener('click', (e) => {
      if (e.target === searchModalContainer) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !searchModalContainer.classList.contains('hidden')) {
        closeModal();
      }
    });

    // --- Pagefind Search Logic ---

    try {
      // Cargar el bundle de Pagefind en tiempo de ejecución sin que Vite lo procese
      // Usamos `new Function` para evitar que el bundler intente resolver la ruta durante build.
      const mod = await new Function('return import("/pagefind/pagefind.js")')().catch(() => null);
      const search: any = mod?.search;
      if (!search) {
        console.error('Pagefind no disponible');
        searchResults.innerHTML = '<div class="text-center text-red-500 p-8 col-span-full">Error al cargar el buscador</div>';
        return;
      }

      // Debounce helper (tipado explícito para evitar warnings TS)
      function debounce(fn: (...args: any[]) => void, wait: number) {
        let t: number | undefined;
        return (...args: any[]) => {
          if (t !== undefined) clearTimeout(t);
          t = window.setTimeout(() => fn(...args), wait);
        };
      }

      const doSearch = async (query: string) => {
        searchResults.innerHTML = '<div class="text-center text-blue-600 p-8 col-span-full">Buscando...</div>';
        try {
          const results = await search(query);
          if (!results || !results.results || results.results.length === 0) {
            searchResults.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">No se encontraron resultados para: <strong class="font-semibold text-gray-700">${query}</strong></div>`;
            return;
          }

          searchResults.innerHTML = '';
          for (const result of results.results.slice(0, 20)) {
            const data = await result.data();
            const link = document.createElement('a');
            link.href = data.url;
            link.className = 'block p-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:shadow-md hover:-translate-y-0.5 transition-all duration-150';
            link.innerHTML = `
              <div class="font-bold text-blue-600 mb-1.5">${data.meta.title || 'Sin título'}</div>
              <div class="text-gray-700 text-sm leading-relaxed">${data.excerpt || 'Sin descripción disponible'}</div>
              ${data.meta && data.meta.date ? `<div class="text-xs text-gray-500 mt-2">${new Date(data.meta.date).toLocaleDateString('es-ES')}</div>` : ''}
            `;
            searchResults.appendChild(link);
          }
        } catch (err) {
          console.error('Error en búsqueda:', err);
          searchResults.innerHTML = '<div class="text-center text-red-500 p-8 col-span-full">Error al realizar la búsqueda</div>';
        }
      };

      const handler = debounce((e: Event) => {
        const query = ((e.target as HTMLInputElement).value || '').trim();
        if (query.length < 2) {
          searchResults.innerHTML = '<div class="text-center text-gray-500 p-8 col-span-full">Escribe al menos 2 caracteres para buscar</div>';
          return;
        }
        void doSearch(query);
      }, 250);

      searchInput.addEventListener('input', handler);

      // Iniciar con mensaje
      searchResults.innerHTML = '<div class="text-center text-gray-500 p-8 col-span-full">Escribe para buscar en el blog</div>';
    } catch (error) {
      console.error('Error cargando Pagefind:', error);
      searchResults.innerHTML = '<div class="text-center text-red-500 p-8 col-span-full">Error al cargar el buscador</div>';
    }
  });
</script>