---
// Componente de carrito: se renderiza en cliente y escucha eventos 'cart-updated'
---

<div id="shoppingCartRoot">
  <div class="bg-white rounded-xl shadow-lg">
    <div class="p-6">
      <h5 class="text-2xl font-bold text-gray-800 mb-4">Tu carrito</h5>
      <div id="cartItems" class="mt-4 space-y-4"></div>
      <div id="cartSummary" class="mt-4 border-t border-gray-200 pt-4"></div>
      <div class="mt-4 flex space-x-2">
        <button id="clearCartBtn" class="px-4 py-2 text-sm rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors">Vaciar carrito</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Este script asume que /scripts/cart-store.js está cargado (define window.Cart)
  function formatPrice(v: any) { return '€' + Number(v).toFixed(2); }

  function renderCart() {
    const root = document.getElementById('shoppingCartRoot');
    const Cart: any = (globalThis as any).Cart;
    if (!root || !Cart) return;
    const itemsContainer = document.getElementById('cartItems');
    const summary = document.getElementById('cartSummary');
    if (!itemsContainer || !summary) return;
    const items = Cart.get();

    if (!items || items.length === 0) {
      itemsContainer!.innerHTML = '<div class="text-gray-500 py-4">Tu carrito está vacío</div>';
      summary!.innerHTML = '';
      return;
    }
    itemsContainer!.innerHTML = '';
    let total = 0;
    for (const it of items) {
      total += it.price * it.quantity;
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      div.innerHTML = `
        <div class="flex items-center space-x-4">
          <img src="${it.image}" alt="${it.title}" class="w-14 h-14 object-cover rounded-md"/>
          <div>
            <div class="font-semibold text-gray-800">${it.title}</div>
            <div class="text-gray-500 text-sm">${formatPrice(it.price)} × ${it.quantity}</div>
          </div>
        </div>
        <div class="flex space-x-2 items-center">
          <button class="cart-decrease w-7 h-7 flex items-center justify-center text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors" data-id="${it.id}">−</button>
          <button class="cart-increase w-7 h-7 flex items-center justify-center text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors" data-id="${it.id}">+</button>
          <button class="cart-remove w-7 h-7 flex items-center justify-center text-sm rounded-md border border-red-300 text-red-500 hover:bg-red-50 transition-colors" data-id="${it.id}">&times;</button>
        </div>
      `;
      itemsContainer.appendChild(div);
    }

    summary!.innerHTML = `<div class="font-bold text-lg text-gray-800 text-right">Total: ${formatPrice(total)}</div>`;

    // attach handlers
    for (const b of Array.from(document.querySelectorAll('.cart-decrease'))) {
      b.addEventListener('click', () => {
        const id = (b as Element).getAttribute('data-id');
        const current = Cart.get().find((x: any) => x.id === id);
        if (current) Cart.update(id, current.quantity - 1);
      });
    }
    for (const b of Array.from(document.querySelectorAll('.cart-increase'))) {
      b.addEventListener('click', () => {
        const id = (b as Element).getAttribute('data-id');
        const current = Cart.get().find((x: any) => x.id === id);
        if (current) Cart.update(id, current.quantity + 1);
      });
    }
    for (const b of Array.from(document.querySelectorAll('.cart-remove'))) {
      b.addEventListener('click', () => {
        const id = (b as Element).getAttribute('data-id');
        if (id) Cart.remove(id);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const Cart: any = (globalThis as any).Cart;
    if (Cart) renderCart();
    window.addEventListener('cart-updated', renderCart);
    const clearBtn = document.getElementById('clearCartBtn');
    if (clearBtn) clearBtn.addEventListener('click', () => Cart && Cart.clear());
  });
</script>
