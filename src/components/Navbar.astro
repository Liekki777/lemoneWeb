---
// src/components/Navbar.astro
import Search from './Search.astro';
---

<!-- NAVBAR SIMPLE Y ELEGANTE -->
<nav class="fixed top-0 left-0 right-0 bg-[#0d1117] shadow-lg z-50 h-16">
  <div class="container mx-auto px-4 flex items-center justify-between h-full">
    <a class="text-white font-bold text-3xl" href="/">Lemone</a>

    <!-- MENÚ DESKTOP -->
    <div class="hidden lg:flex items-center space-x-8">
      <a href="/" class="text-white text-lg hover:text-gray-300 transition-colors">Inicio</a>
      <a href="/blog" class="text-red-500 font-bold text-lg hover:text-red-400 transition-colors">Blog</a>
      
      <a href="/guias" class="text-white text-lg hover:text-gray-300 transition-colors">Guías</a>
      <a href="/destacado" class="text-white text-lg hover:text-gray-300 transition-colors">Destacado</a>
      <a href="/noticias" class="text-white text-lg hover:text-gray-300 transition-colors">Noticias</a>
      <a href="/tienda" class="text-white text-lg hover:text-gray-300 transition-colors">Tienda</a>
      <a href="/juegos" class="text-white text-lg hover:text-gray-300 transition-colors">Juegos</a>
      <a href="/dashboard" class="text-white text-lg hover:text-gray-300 transition-colors">Dashboard</a>
        <button type="button" id="cartBtnDesktop" class="relative text-white p-0" aria-label="Abrir carrito">
          <i class="bi bi-cart text-xl"></i>
          <span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full" style="display:none;">0</span>
        </button>
      <button id="searchBtnDesktop" class="flex items-center px-3 py-1.5 border border-white text-white rounded-md text-sm hover:bg-white hover:text-gray-900 transition-colors">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>

    <!-- BOTÓN BUSCAR (móvil) + HAMBURGUESA (se mantiene para mejoras futuras) -->
    <div class="lg:hidden flex items-center space-x-3">
      <button id="searchBtnMobile" class="flex items-center px-3 py-1.5 border border-white text-white rounded-md text-sm hover:bg-white hover:text-gray-900 transition-colors" aria-label="Buscar">
        <i class="bi bi-search"></i>
      </button>
      <button id="mobileMenuBtn" class="flex items-center justify-center w-11 h-11 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors" aria-label="Abrir menú">
        <i class="bi bi-list text-3xl"></i>
      </button>
    </div>
  </div>
</nav>

<!-- BOTTOM NAV MÓVIL (estilo compacto tipo nintenderos) -->
<nav id="mobileBottomNav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-gray-900 text-white flex justify-around items-center py-2 shadow-lg z-50">
  <a href="/" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Inicio">
    <i class="bi bi-house text-2xl"></i>
    <span class="block text-[11px] leading-none">Inicio</span>
  </a>
  <button type="button" id="cartBtnMobile" class="flex flex-col items-center text-white text-xs no-underline relative p-0" aria-label="Abrir carrito">
    <i class="bi bi-cart text-2xl"></i>
    <span id="cart-count-mobile" class="absolute top-0 right-1.5 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full" style="display:none;">0</span>
    <span class="block text-[11px] leading-none">Carrito</span>
  </button>
  <a href="/blog" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Blog">
    <i class="bi bi-journal-text text-2xl"></i>
    <span class="block text-[11px] leading-none">Blog</span>
  </a>
  <a href="/guias" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Guías">
    <i class="bi bi-book text-2xl"></i>
    <span class="block text-[11px] leading-none">Guías</span>
  </a>
  <a href="/destacado" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Destacado">
    <i class="bi bi-star text-2xl"></i>
    <span class="block text-[11px] leading-none">Destacado</span>
  </a>
  <a href="/noticias" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Noticias">
    <i class="bi bi-megaphone text-2xl"></i>
    <span class="block text-[11px] leading-none">Noticias</span>
  </a>
  <a href="/tienda" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Tienda">
    <i class="bi bi-shop text-2xl"></i>
    <span class="block text-[11px] leading-none">Tienda</span>
  </a>
  <a href="/juegos" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Juegos">
    <i class="bi bi-controller text-2xl"></i>
    <span class="block text-[11px] leading-none">Juegos</span>
  </a>
  <a href="/dashboard" class="flex flex-col items-center text-white text-xs no-underline hover:text-gray-300 transition-colors" aria-label="Dashboard">
    <i class="bi bi-grid-1x2 text-2xl"></i>
    <span class="block text-[11px] leading-none">Dashboard</span>
  </a>
</nav>

<!-- MODAL DE BÚSQUEDA (siempre en el DOM → Pagefind lo detecta) -->
<!-- Renderizo el componente de búsqueda personalizado (modal + script) -->
<Search />
<!-- NOTA: La funcionalidad de abrir/cerrar el modal de búsqueda debe ser implementada con JavaScript personalizado. -->

<!-- OFFCANVAS MÓVIL (se abre desde el botón hamburguesa) -->
<div class="fixed top-0 right-0 w-80 max-w-xs h-full bg-gray-900 text-white transform translate-x-full transition-transform duration-300 ease-in-out z-[1050]" tabindex="-1" id="mobileOffcanvas" aria-labelledby="mobileOffcanvasLabel">
  <div class="flex justify-between items-center p-4 border-b border-gray-700">
    <h5 class="text-xl font-bold" id="mobileOffcanvasLabel">Menú</h5>
    <button type="button" id="closeMobileOffcanvasBtn" class="text-white text-2xl leading-none hover:text-gray-300" aria-label="Cerrar">
      &times;
    </button>
  </div>
  <div class="p-4 flex-grow">
    <div class="space-y-2">
      <a href="/" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Inicio</a>
      <a href="/blog" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Blog</a>
      <a href="/guias" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Guías</a>
      <a href="/destacado" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Destacado</a>
      <a href="/noticias" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Noticias</a>
      <a href="/tienda" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Tienda</a>
      <a href="/juegos" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Juegos</a>
      <a href="/dashboard" class="block p-3 text-white hover:bg-gray-800 rounded-md transition-colors">Dashboard</a>
    </div>
  </div>
</div>
<!-- NOTA: La funcionalidad de abrir/cerrar este offcanvas debe ser implementada con JavaScript personalizado. -->

<!-- OFFCANVAS CARRITO -->
<div class="fixed top-0 right-0 w-80 max-w-xs h-full bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-[1050]" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
  <div class="flex justify-between items-center p-4 border-b border-gray-200">
    <h5 class="text-xl font-bold text-gray-800" id="cartOffcanvasLabel">Tu carrito</h5>
    <button type="button" id="closeCartOffcanvasBtn" class="text-gray-500 text-2xl leading-none hover:text-gray-700" aria-label="Cerrar">
      &times;
    </button>
  </div>
  <div class="p-4 flex-grow">
    <div id="cartOffcanvasItems" class="space-y-2"></div>
  </div>
  <div class="p-4 border-t border-gray-200 flex justify-between items-center">
    <div id="cartOffcanvasTotal" class="font-bold text-lg">Total: €0.00</div>
    <div>
      <a href="/tienda/carrito" class="px-3 py-1.5 text-sm rounded-md border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors mr-2">Ver carrito</a>
      <button id="cartCheckoutBtn" class="px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700 transition-colors">Pagar</button>
    </div>
  </div>
</div>
<!-- NOTA: La funcionalidad de abrir/cerrar este offcanvas debe ser implementada con JavaScript personalizado. -->
        <style is:global>
    /* El padding-top del body ahora se gestiona en Layout.astro */
    /* El padding-bottom del body se gestiona en Layout.astro o por el contenido principal */

  /* Animaciones para enlaces del bottom nav */
  #mobileBottomNav a {
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  #mobileBottomNav a:active {
    transform: scale(0.85);
    filter: brightness(0.9);
  }

  #mobileBottomNav a:hover {
    transform: scale(1.1);
    text-shadow: 0 0 8px rgba(220, 0, 0, 0.5);
  }

  /* Efecto de ripple en móvil (pulse visual) */
  @media (hover: none) {
    #mobileBottomNav a:active {
      animation: pulse-ripple 0.6s ease-out;
    }
  }

  @keyframes pulse-ripple {
    0% {
      box-shadow: 0 0 0 0 rgba(220, 0, 0, 0.7);
      transform: scale(0.85);
    }
    70% {
      box-shadow: 0 0 0 12px rgba(220, 0, 0, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(220, 0, 0, 0);
      transform: scale(1);
    }
  }
</style>
<script>
  function updateCartCount() {
    try {
      const Cart = (globalThis as any).Cart;
      const count = Cart ? (Cart.get() || []).reduce((s: number, i: any) => s + (i.quantity || 0), 0) : 0;
      const desktop = document.getElementById('cart-count');
      const mobile = document.getElementById('cart-count-mobile');
      if (desktop) {
        if (count > 0) { desktop.style.display = 'inline-block'; desktop.textContent = String(count); }
        else { desktop.style.display = 'none'; }
      }
      if (mobile) {
        if (count > 0) { mobile.style.display = 'inline-block'; mobile.textContent = String(count); }
        else { mobile.style.display = 'none'; }
      }
    } catch (e) { /* silent */ }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateCartCount();
    window.addEventListener('cart-updated', updateCartCount);
    // Render offcanvas content
    const renderOffcanvas = () => {
      try {
        const Cart: any = (globalThis as any).Cart;
        const items = Cart ? (Cart.get() || []) : [];
        const container = document.getElementById('cartOffcanvasItems');
        const totalEl = document.getElementById('cartOffcanvasTotal');
        if (!container || !totalEl) return;
        container.innerHTML = ''; // Limpiar contenido previo
        let total = 0;
        if (!items.length) {
          container.innerHTML = '<div class="text-gray-500">Tu carrito está vacío</div>';
        } else {
          for (const it of items) {
            total += it.price * (it.quantity || 1); // Asegurarse de que quantity sea al menos 1
            const a = document.createElement('div');
            a.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-md';
            a.innerHTML = `
              <div class="flex items-center gap-3">
                <img src="${it.image}" alt="${it.title}" class="w-12 h-12 object-cover rounded-md" />
                <div>
                  <div class="font-semibold text-sm mb-1">${it.title}</div>
                  <div class="text-sm text-gray-500">€${Number(it.price).toFixed(2)} × ${it.quantity}</div>
                </div>
              </div>
              <div class="flex space-x-1">
                <button class="px-2 py-1 text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors cart-off-decr" data-id="${it.id}">−</button>
                <button class="px-2 py-1 text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors cart-off-incr" data-id="${it.id}">+</button>
              </div>
            `;
            container.appendChild(a);
          }
        }
        totalEl.textContent = `Total: €${Number(total).toFixed(2)}`;
        // attach handlers
        for (const b of Array.from(container.querySelectorAll('.cart-off-decr'))) {
          b.addEventListener('click', () => {
            const id = (b as Element).getAttribute('data-id');
            const current = Cart.get().find((x: any) => x.id === id);
            if (current) Cart.update(id, current.quantity - 1);
            renderOffcanvas();
          });
        }
        for (const b of Array.from(container.querySelectorAll('.cart-off-incr'))) {
          b.addEventListener('click', () => {
            const id = (b as Element).getAttribute('data-id');
            const current = Cart.get().find((x: any) => x.id === id);
            if (current) Cart.update(id, current.quantity + 1);
            renderOffcanvas();
          });
        }
      } catch (e) { /* silent */ }
    };

    // --- Funcionalidad de Offcanvas y Modal (requiere JS personalizado) ---
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileOffcanvas = document.getElementById('mobileOffcanvas');
    const closeMobileOffcanvasBtn = document.getElementById('closeMobileOffcanvasBtn');

    const cartBtnDesktop = document.getElementById('cartBtnDesktop');
    const cartBtnMobile = document.getElementById('cartBtnMobile');
    const cartOffcanvas = document.getElementById('cartOffcanvas');
    const closeCartOffcanvasBtn = document.getElementById('closeCartOffcanvasBtn');

    // Función genérica para abrir/cerrar offcanvas
    const toggleOffcanvas = (offcanvasElement: HTMLElement | null, show: boolean) => {
      if (offcanvasElement) {
        offcanvasElement.classList.toggle('translate-x-full', !show);
      }
    };

    mobileMenuBtn?.addEventListener('click', () => toggleOffcanvas(mobileOffcanvas, true));
    closeMobileOffcanvasBtn?.addEventListener('click', () => toggleOffcanvas(mobileOffcanvas, false));

    cartBtnDesktop?.addEventListener('click', () => { toggleOffcanvas(cartOffcanvas, true); renderOffcanvas(); });
    cartBtnMobile?.addEventListener('click', () => { toggleOffcanvas(cartOffcanvas, true); renderOffcanvas(); });
    closeCartOffcanvasBtn?.addEventListener('click', () => toggleOffcanvas(cartOffcanvas, false));

    window.addEventListener('cart-updated', renderOffcanvas);
    // checkout button: go to carrito page
    const checkoutBtn = document.getElementById('cartCheckoutBtn');
    if (checkoutBtn) checkoutBtn.addEventListener('click', () => { window.location.href = '/tienda/carrito'; });
  });
</script>