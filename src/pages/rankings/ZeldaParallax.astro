---
// src/components/ZeldaParallax.astro
import Layout from '../../layouts/Layout.astro';

interface Game {
  id: number;
  name: string;
  background_image: string;
  metacritic: number;
  released: string;
}

// IMPORTANTE: Reemplaza esto con tu API Key de RAWG o configúrala en tu archivo .env como RAWG_API_KEY
const API_KEY = "ad004328e48949f8a05b5558407ffdbe";

let games: Game[] = [];
let error = "";

try {
  // 1. Fetch a la API: Buscamos "The Legend of Zelda", ordenamos por metacritic descendente
  const response = await fetch(
    `https://api.rawg.io/api/games?key=${API_KEY}&search=The+Legend+of+Zelda&ordering=-metacritic&page_size=40`
  );

  if (!response.ok) {
    throw new Error(`Error al conectar con RAWG: ${response.statusText}`);
  }

  const data = await response.json();

  // 2. Filtrado adicional: Aseguramos que sean juegos relevantes, tengan imagen y puntuación
  games = data.results.filter((g: any) => 
    g.metacritic && 
    g.background_image && 
    g.name.toLowerCase().includes("zelda")
  ).slice(0, 10);

} catch (e) {
  console.error(e);
  error = "No se pudieron cargar los juegos. Por favor verifica tu API Key de RAWG.";
}
---
<style is:global>
  html {
    scroll-snap-type: y mandatory;
  }
  .zelda-section {
    scroll-snap-align: start;
  }
</style>
<Layout title="Ranking de Juegos de Zelda">
<div class="bg-black min-h-screen w-full">
  {error && <div class="text-red-500 text-center pt-32 text-2xl font-bold">{error}</div>}

  {games.map((game) => (
    <section class="zelda-section relative w-full h-screen overflow-hidden flex items-center justify-center">
      <!-- Fondo con imagen para el efecto Parallax -->
      <!-- Altura 120% para tener espacio de desplazamiento vertical -->
      <div 
        class="zelda-bg absolute top-0 left-0 w-full h-[120%] bg-cover bg-center will-change-transform"
        style={`background-image: url('${game.background_image}')`}
      >
        <div class="absolute inset-0 bg-black/50 backdrop-blur-[2px]"></div>
      </div>

      <!-- Contenido del juego -->
      <div class="zelda-content relative z-10 text-center text-white p-6 max-w-4xl translate-y-12 opacity-0">
        <h2 class="text-5xl md:text-7xl font-bold mb-6 drop-shadow-2xl tracking-tight">{game.name}</h2>
        <div class="flex justify-center items-center gap-6">
          <div class="flex flex-col items-center">
            <span class="text-sm text-gray-300 uppercase tracking-widest mb-1">Metacritic</span>
            <span class="bg-green-600 text-white text-2xl font-bold px-4 py-1 rounded shadow-lg border border-green-400">
              {game.metacritic}
            </span>
          </div>
          <div class="h-10 w-px bg-gray-500/50"></div>
          <div class="flex flex-col items-center">
            <span class="text-sm text-gray-300 uppercase tracking-widest mb-1">Lanzamiento</span>
            <span class="text-xl font-medium text-white">
              {game.released ? new Date(game.released).getFullYear() : 'N/A'}
            </span>
          </div>
        </div>
      </div>
    </section>
  ))}
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const sections = document.querySelectorAll<HTMLElement>('.zelda-section');

  sections.forEach((section) => {
    const bg = section.querySelector('.zelda-bg');
    const content = section.querySelector('.zelda-content');
    const title = content?.querySelector('h2');
    const stats = content?.querySelector('.flex');

    // 1. Animación de Fondo Mejorada (Movimiento + Escala + Inercia)
    if (bg) {
      gsap.fromTo(bg, 
        { y: "-20%", scale: 1.15 }, // Empieza con zoom y desplazado
        {
          y: "20%",    
          scale: 1,    // El zoom se reduce ligeramente al bajar
          ease: "none",
          scrollTrigger: {
            trigger: section,
            start: "top bottom", 
            end: "bottom top",   
            scrub: 0.5 // Añade inercia para suavizar el movimiento
          }
        }
      );
    }

    // 2. Animación de Contenido (Multicapa)
    if (content) {
      // A. Opacidad: Aparece en el centro, desaparece en los bordes
      gsap.to(content, {
        opacity: 1,
        duration: 0.5,
        scrollTrigger: {
          trigger: section,
          start: "top 65%", // Aparece un poco más tarde
          end: "bottom 35%", // Desaparece antes de salir del todo
          toggleActions: "play reverse play reverse"
        }
      });

      // B. Parallax del Texto: El título se mueve más rápido que las estadísticas para dar profundidad
      if (title) {
        gsap.fromTo(title, { y: 50 }, { y: -50, ease: "none", scrollTrigger: { trigger: section, start: "top bottom", end: "bottom top", scrub: true } });
      }
      
      if (stats) {
        gsap.fromTo(stats, { y: 100 }, { y: -100, ease: "none", scrollTrigger: { trigger: section, start: "top bottom", end: "bottom top", scrub: true } });
      }
    }
  });
</script>
</Layout>